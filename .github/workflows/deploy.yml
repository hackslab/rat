name: Deploy Server

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Executing remote ssh commands using password/key
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e
            
            # --- Configuration ---
            # Update this path if you cloned the repo elsewhere
            PROJECT_DIR=~/rat-project
            SERVICE_NAME=rat-server
            # ---------------------

            echo "[*] Starting deployment to $PROJECT_DIR..."

            # 1. Navigate to project
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "[!] Project directory not found at $PROJECT_DIR"
              exit 1
            fi
            cd "$PROJECT_DIR"

            # 2. Update Code
            echo "[*] Pulling latest changes from git..."
            git fetch origin
            git reset --hard origin/main 
            # using reset --hard is often safer for deployments to avoid merge conflicts, 
            # but git pull is also fine if no local changes are expected.

            # 3. Update Dependencies
            echo "[*] Updating Python dependencies..."
            if [ -d "venv" ]; then
                source venv/bin/activate
                if [ -f "requirements-server.txt" ]; then
                    pip install -r requirements-server.txt
                fi
            else
                echo "[!] 'venv' directory not found! Run deployment/setup.sh on server first."
                exit 1
            fi

            # 4. Restart Service
            echo "[*] Restarting $SERVICE_NAME service..."
            # This requires the user to have NOPASSWD sudo rights for systemctl, 
            # or the SSH user to be root (discouraged).
            sudo systemctl restart "$SERVICE_NAME"
            
            echo "[+] Deployment completed successfully."
